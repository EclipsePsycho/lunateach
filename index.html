import json
import logging
import os
from datetime import datetime
from telegram import Update, WebAppInfo, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, MessageHandler, filters

# --- CONFIGURATION ---
TOKEN = "8370587190:AAHRdRZEljVbt-zQtGIG8QQxOqghVLLgc6I"
# Make sure this URL matches your GitHub Pages link exactly
MINI_APP_URL = "https://eclipsepsycho.github.io/lunateach/"

# Files
STUDENTS_FILE = "students.json"
TEACHERS_FILE = "teachers.json"
REQUESTS_FILE = "requests.json"

logging.basicConfig(format='%(asctime)s - %(levelname)s - %(message)s', level=logging.INFO)

# --- HELPER FUNCTIONS ---
def load_data(file):
    if not os.path.exists(file):
        return {}
    try:
        with open(file, "r") as f:
            return json.load(f)
    except Exception as e:
        logging.error(f"Error loading {file}: {e}")
        return {}

def save_data(file, data):
    with open(file, "w") as f:
        json.dump(data, f, indent=4)

# --- BOT HANDLERS ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    reply_kb = ReplyKeyboardMarkup(
        [[KeyboardButton("üöÄ Open LunaTeach", web_app=WebAppInfo(url=MINI_APP_URL))]],
        resize_keyboard=True
    )
    await update.message.reply_text(
        "üåô *LunaTeach*\n\nMaster English with real teachers.\nTap below to launch the app:",
        parse_mode="Markdown",
        reply_markup=reply_kb
    )

async def handle_web_app_data(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message or not update.message.web_app_data:
        return

    data = update.message.web_app_data.data
    user = update.effective_user
    uid = str(user.id)
    username = user.username or "NoUsername"
    first_name = user.first_name

    try:
        payload = json.loads(data)
        action = payload.get("action")
        
        students = load_data(STUDENTS_FILE)
        teachers = load_data(TEACHERS_FILE)
        requests = load_data(REQUESTS_FILE)

        # --- SCENARIO 1: SAVE PROFILE ---
        if action == "save_profile":
            role = payload["role"]
            profile = payload["profile"]
            
            # Inject Telegram data into the profile
            profile["telegram_id"] = uid
            profile["name"] = first_name
            profile["username"] = username
            
            if role == "student":
                students[uid] = profile
                save_data(STUDENTS_FILE, students)
                await update.message.reply_text(f"‚úÖ Student profile saved! ({profile['goal']})")
            else:
                teachers[uid] = profile
                save_data(TEACHERS_FILE, teachers)
                await update.message.reply_text("‚úÖ Teacher profile live! Students can now see you.")

        # --- SCENARIO 2: SEND REQUEST ---
        elif action == "send_request":
            teacher_id = str(payload["teacher_id"]) # Ensure ID is string
            student_name = payload["student_name"]

            # Save to requests database
            if teacher_id not in requests:
                requests[teacher_id] = []
            
            requests[teacher_id].append({
                "student_id": uid,
                "student_name": student_name,
                "username": username,
                "timestamp": datetime.now().isoformat()
            })
            save_data(REQUESTS_FILE, requests)

            # 1. Notify the Student
            await update.message.reply_text(f"‚úÖ Request sent to teacher!")
            
            # 2. Notify the Teacher (if they have started the bot)
            try:
                await context.bot.send_message(
                    chat_id=int(teacher_id),
                    text=f"üîî *New Student Request!*\n\nüë§ {student_name} (@{username})\nwants to connect.\n\nCheck your schedule!",
                    parse_mode="Markdown"
                )
            except Exception as e:
                logging.warning(f"Could not message teacher {teacher_id}: {e}")

    except Exception as e:
        logging.error(f"Bot Logic Error: {e}")
        await update.message.reply_text("‚ö†Ô∏è Error processing data.")

if __name__ == "__main__":
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, handle_web_app_data))
    
    print("üöÄ LunaTeach Bot is RUNNING...")
    app.run_polling(drop_pending_updates=True)
