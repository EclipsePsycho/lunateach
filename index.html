<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LunaTeach</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: var(--tg-theme-bg-color, #ffffff);
      --text-color: var(--tg-theme-text-color, #000000);
      --hint-color: var(--tg-theme-hint-color, #999999);
      --link-color: var(--tg-theme-link-color, #2481cc);
      --btn-color: var(--tg-theme-button-color, #3390ec);
      --btn-text: var(--tg-theme-button-text-color, #ffffff);
      --sec-bg: var(--tg-theme-secondary-bg-color, #f4f4f5);
    }
    body { font-family: sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); padding-bottom: 80px; }
    .page { display: none; padding: 20px; }
    .active { display: block; }
    .card { background: var(--sec-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; }
    .main-btn { background: var(--btn-color); color: var(--btn-text); border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; margin-top: 10px; }
    #nav-bar { position: fixed; bottom: 0; width: 100%; display: flex; background: var(--sec-bg); border-top: 1px solid #ddd; height: 60px; align-items: center; justify-content: space-around; }
    .nav-btn { background: none; border: none; color: var(--hint-color); font-size: 12px; }
    .nav-btn.active-nav { color: var(--link-color); font-weight: bold; }
    textarea, select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; background: var(--sec-bg); color: var(--text-color); }
  </style>
</head>
<body>

  <div id="landing" class="page active">
    <h1>üåô LunaTeach</h1>
    <button class="main-btn" onclick="setRole('student')">üéì I'm a Student</button>
    <button class="main-btn" onclick="setRole('teacher')">üßë‚Äçüè´ I'm a Teacher</button>
  </div>

  <div id="setup" class="page">
    <h2>Setup Profile</h2>
    <div id="student-form" style="display:none">
        <label>Goal:</label>
        <select id="goal"><option>IELTS</option><option>Speaking</option></select>
    </div>
    <div id="teacher-form" style="display:none">
        <label>Bio:</label>
        <textarea id="bio" placeholder="Experience..."></textarea>
    </div>
    <button class="main-btn" onclick="saveProfile()">Save & Continue</button>
  </div>

  <div id="market" class="page">
    <h2>Marketplace</h2>
    <div id="teacher-list">Loading...</div>
  </div>

  <div id="me" class="page">
    <h2>My Profile</h2>
    <div id="profile-card" class="card"></div>
    <button class="main-btn" style="background:red" onclick="logout()">Logout</button>
  </div>

  <nav id="nav-bar" style="display:none">
    <button class="nav-btn active-nav" onclick="showPage('market', this)">üîç Find</button>
    <button class="nav-btn" onclick="showPage('me', this)">üë§ Profile</button>
  </nav>

  <script>
    const tg = Telegram.WebApp;
    const API = "https://eclipsepsycho.pythonanywhere.com/api";
    let role = localStorage.getItem('role');
    let profile = JSON.parse(localStorage.getItem('profile'));

    function showPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav'));
            btn.classList.add('active-nav');
        }
        if(id === 'market') loadTeachers();
        if(id === 'me') renderMe();
    }

    function setRole(r) {
        role = r;
        localStorage.setItem('role', r);
        showPage('setup');
        document.getElementById('student-form').style.display = r === 'student' ? 'block' : 'none';
        document.getElementById('teacher-form').style.display = r === 'teacher' ? 'block' : 'none';
    }

    async function saveProfile() {
        const data = {
            telegram_id: tg.initDataUnsafe.user?.id || "123",
            name: tg.initDataUnsafe.user?.first_name || "Guest",
            bio: document.getElementById('bio').value || "No bio",
            subject: document.getElementById('goal').value || "English"
        };
        const res = await fetch(`${API}/save_profile`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({role: role, profile: data})
        });
        if(res.ok) {
            profile = data;
            localStorage.setItem('profile', JSON.stringify(data));
            document.getElementById('nav-bar').style.display = 'flex';
            showPage('market');
        }
    }

    async function loadTeachers() {
        const res = await fetch(`${API}/get_teachers`);
        const teachers = await res.json();
        const list = document.getElementById('teacher-list');
        list.innerHTML = Object.values(teachers).map(t => `
            <div class="card">
                <strong>${t.name}</strong> (${t.subject})<br>${t.bio}
                <button class="main-btn" onclick="connect('${t.telegram_id}')">Connect</button>
            </div>
        `).join('');
    }

    function renderMe() {
        document.getElementById('profile-card').innerHTML = `
            <strong>${profile.name}</strong><br>Role: ${role}<br>Goal/Sub: ${profile.subject}
        `;
    }

    function logout() { localStorage.clear(); location.reload(); }

    if(profile) {
        document.getElementById('nav-bar').style.display = 'flex';
        showPage('market');
    }
  </script>
</body>
</html>
