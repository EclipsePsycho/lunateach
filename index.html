<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LunaTeach Marketplace</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      padding: 20px; 
      margin: 0; 
      background: var(--tg-theme-bg-color); 
      color: var(--tg-theme-text-color); 
      min-height: 100vh;
    }
    h1 { text-align: center; color: var(--tg-theme-link-color); margin: 30px 0; }
    .no-matches { text-align: center; font-size: 1.2em; color: var(--tg-theme-hint-color); margin: 40px; }
    .card { 
      background: var(--tg-theme-secondary-bg-color); 
      border-radius: 16px; 
      padding: 20px; 
      margin: 16px 0; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
      overflow: hidden;
    }
    .photo {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .no-photo {
      width: 100%;
      height: 200px;
      background: var(--tg-theme-hint-color);
      opacity: 0.2;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      margin-bottom: 16px;
    }
    .name { font-size: 1.6em; font-weight: bold; margin-bottom: 8px; }
    .detail { margin: 10px 0; color: var(--tg-theme-hint-color); line-height: 1.5; }
    .bio { font-style: italic; margin: 12px 0; }
    .connect-btn { 
      background: var(--tg-theme-button-color); 
      color: var(--tg-theme-button-text-color); 
      border: none; 
      padding: 16px; 
      width: 100%; 
      border-radius: 12px; 
      font-size: 1.3em; 
      font-weight: bold;
      margin-top: 16px;
      cursor: pointer;
    }
    .user-info { 
      text-align: center; 
      margin: 20px 0; 
      padding: 14px;
      background: var(--tg-theme-secondary-bg-color);
      border-radius: 12px;
      font-size: 1.1em;
      color: var(--tg-theme-hint-color);
    }
  </style>
</head>
<body>
  <div class="user-info" id="user-info">Loading your matches...</div>
  <h1>üîç Find Your Teacher</h1>
  <div id="teachers-list"></div>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const user = Telegram.WebApp.initDataUnsafe.user;
    const initData = Telegram.WebApp.initData;  // For secure sending

    const userInfo = document.getElementById('user-info');
    if (user) {
      userInfo.innerText = `Hey ${user.first_name}! Finding teachers for your goal...`;
    }

    // === STEP 1: Get student's goal + all teachers securely from bot ===
    // We send initData (secure auth) to bot ‚Üí bot replies with JSON data
    const payload = JSON.stringify({
      action: "get_teachers",
      init_data: initData  // This proves it's a real Telegram user
    });

    Telegram.WebApp.sendData(payload);

    // === STEP 2: Listen for data from bot ===
    Telegram.WebApp.onEvent('web_app_data_received', function(data) {
      try {
        const response = JSON.parse(data);
        if (response.teachers && response.teachers.length > 0) {
          renderTeachers(response.teachers, response.student_goal);
        } else {
          document.getElementById('teachers-list').innerHTML = 
            `<div class="no-matches">üòî No teachers available for <strong>${response.student_goal || 'your goal'}</strong> yet.<br>Check back soon!</div>`;
        }
      } catch (e) {
        document.getElementById('teachers-list').innerHTML = 
          `<div class="no-matches">‚ö†Ô∏è Error loading teachers. Try again.</div>`;
      }
    });

    function renderTeachers(teachers, goal) {
      const list = document.getElementById('teachers-list');
      userInfo.innerText = `Found ${teachers.length} teacher(s) for ${goal} üéØ`;

      teachers.forEach(teacher => {
        const card = document.createElement('div');
        card.className = 'card';

        const photoHtml = teacher.photo_url 
          ? `<img src="${teacher.photo_url}" class="photo" alt="${teacher.name}">`
          : `<div class="no-photo">üë§</div>`;

        card.innerHTML = `
          ${photoHtml}
          <div class="name">üßë‚Äçüè´ ${teacher.name}</div>
          <div class="detail"><strong>Subjects:</strong> ${teacher.subjects.join(', ')}</div>
          <div class="detail"><strong>Available:</strong> ${teacher.availability}</div>
          <div class="detail bio">${teacher.bio || 'No bio yet.'}</div>
          <button class="connect-btn" data-tid="${teacher.id}">ü§ù Connect Now</button>
        `;
        list.appendChild(card);
      });

      // Connect buttons
      document.querySelectorAll('.connect-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tid = btn.dataset.tid;
          const connectPayload = JSON.stringify({
            action: "connect",
            teacher_id: tid,
            student_name: user ? (user.first_name + (user.last_name ? ' ' + user.last_name : '')) : "Student",
            init_data: initData
          });

          Telegram.WebApp.sendData(connectPayload);
          btn.innerText = "‚úÖ Request Sent!";
          btn.disabled = true;
          btn.style.opacity = "0.7";
        });
      });
    }
  </script>
</body>
</html>
